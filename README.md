# åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ

ä¸€ä¸ªåŸºäºGoè¯­è¨€å’Œetcdçš„é«˜æ€§èƒ½åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿï¼Œæ”¯æŒä»»åŠ¡ä¼˜å…ˆçº§è°ƒåº¦ã€è´Ÿè½½å‡è¡¡ã€æ•…éšœè‡ªåŠ¨æ¢å¤ç­‰ç‰¹æ€§ã€‚

## ç‰¹æ€§

- ğŸš€ **åˆ†å¸ƒå¼æ¶æ„**ï¼šæ”¯æŒå¤šä¸ªè°ƒåº¦å™¨å’Œå·¥ä½œèŠ‚ç‚¹ï¼Œæ°´å¹³æ‰©å±•
- ğŸ“Š **ä¼˜å…ˆçº§è°ƒåº¦**ï¼šæ”¯æŒå¤šçº§ä¼˜å…ˆçº§ä»»åŠ¡é˜Ÿåˆ—
- âš–ï¸ **è´Ÿè½½å‡è¡¡**ï¼šæä¾›è½®è¯¢ã€éšæœºã€æœ€å°‘è´Ÿè½½ã€åŠ æƒç­‰å¤šç§ç­–ç•¥
- ğŸ”„ **è‡ªåŠ¨é‡è¯•**ï¼šä»»åŠ¡å¤±è´¥è‡ªåŠ¨é‡è¯•ï¼Œå¯é…ç½®é‡è¯•æ¬¡æ•°
- ğŸ›¡ï¸ **æ•…éšœæ¢å¤**ï¼šè‡ªåŠ¨æ£€æµ‹èŠ‚ç‚¹æ•…éšœå¹¶é‡æ–°åˆ†é…ä»»åŠ¡
- ğŸ“ˆ **å®æ—¶ç›‘æ§**ï¼šæä¾›èŠ‚ç‚¹å’Œä»»åŠ¡çŠ¶æ€ç»Ÿè®¡ä¿¡æ¯
- ğŸ”Œ **å¯æ‰©å±•**ï¼šæ”¯æŒè‡ªå®šä¹‰ä»»åŠ¡æ‰§è¡Œå™¨

## æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    å®¢æˆ·ç«¯        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚ è°ƒåº¦å™¨   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚       etcd               â”‚
    â”‚  (åè°ƒæœåŠ¡ã€ä»»åŠ¡å­˜å‚¨ã€é˜Ÿåˆ—) â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚ å·¥ä½œèŠ‚ç‚¹ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Go 1.21+ (å¦‚æœä½¿ç”¨æºç ç¼–è¯‘)
- Docker å’Œ Docker Compose (å¦‚æœä½¿ç”¨ Docker éƒ¨ç½²)
- etcd 3.5+ (å¦‚æœæœ¬åœ°è¿è¡Œ)

### Docker Compose éƒ¨ç½²ï¼ˆæ¨èï¼‰

ä½¿ç”¨ Docker Compose å¯ä»¥å¿«é€Ÿå¯åŠ¨æ•´ä¸ªç³»ç»Ÿï¼ŒåŒ…æ‹¬ etcdã€è°ƒåº¦å™¨å’Œå¤šä¸ªå·¥ä½œèŠ‚ç‚¹ã€‚

**1. å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼š**
```bash
docker-compose up -d
```

**2. æŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼š**
```bash
docker-compose ps
```

**3. æŸ¥çœ‹æ—¥å¿—ï¼š**
```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose logs -f

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker-compose logs -f scheduler
docker-compose logs -f worker-1
docker-compose logs -f etcd
```

**4. æäº¤ä»»åŠ¡ï¼ˆä½¿ç”¨å®¢æˆ·ç«¯å®¹å™¨ï¼‰ï¼š**
```bash
# æäº¤å•ä¸ªä»»åŠ¡
docker-compose run --rm client \
  --etcd-endpoints=etcd:2379 \
  --queue=default \
  --type=echo \
  --name=test-task \
  --priority=1 \
  --count=1

# æäº¤å¤šä¸ªä»»åŠ¡
docker-compose run --rm client \
  --etcd-endpoints=etcd:2379 \
  --queue=default \
  --type=echo \
  --name=batch-task \
  --priority=2 \
  --count=100

# æäº¤é«˜ä¼˜å…ˆçº§ä»»åŠ¡
docker-compose run --rm client \
  --etcd-endpoints=etcd:2379 \
  --queue=default \
  --type=compute \
  --name=urgent-task \
  --priority=3 \
  --count=5
```

**5. åœæ­¢æ‰€æœ‰æœåŠ¡ï¼š**
```bash
docker-compose down
```

**6. åœæ­¢å¹¶æ¸…ç†æ•°æ®ï¼š**
```bash
docker-compose down -v
```

**æ‰©å±•å·¥ä½œèŠ‚ç‚¹ï¼š**

å¦‚æœéœ€è¦æ›´å¤šå·¥ä½œèŠ‚ç‚¹ï¼Œå¯ä»¥ä¿®æ”¹ `docker-compose.yml` æ·»åŠ æ›´å¤š worker æœåŠ¡ï¼Œæˆ–è€…ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨é¢å¤–çš„ workerï¼š

```bash
docker-compose up -d --scale worker-1=3
```

**æœåŠ¡è¯´æ˜ï¼š**

- `etcd`: etcd æœåŠ¡ï¼Œç«¯å£ 2379ï¼ˆå®¢æˆ·ç«¯ï¼‰ã€2380ï¼ˆèŠ‚ç‚¹é—´é€šä¿¡ï¼‰
- `scheduler`: è°ƒåº¦å™¨æœåŠ¡ï¼Œ1 ä¸ªå®ä¾‹
- `worker-1`, `worker-2`, `worker-3`: å·¥ä½œèŠ‚ç‚¹æœåŠ¡ï¼Œé»˜è®¤ 3 ä¸ªå®ä¾‹

**ç¯å¢ƒå˜é‡é…ç½®ï¼š**

å¯ä»¥é€šè¿‡ä¿®æ”¹ `docker-compose.yml` ä¸­çš„ `command` å‚æ•°æ¥è°ƒæ•´å„æœåŠ¡çš„é…ç½®ï¼Œä¾‹å¦‚ï¼š
- ä¿®æ”¹ `--max-concurrent` è°ƒæ•´å·¥ä½œèŠ‚ç‚¹å¹¶å‘æ•°
- ä¿®æ”¹ `--strategy` è°ƒæ•´è´Ÿè½½å‡è¡¡ç­–ç•¥
- ä¿®æ”¹ `--log-level` è°ƒæ•´æ—¥å¿—çº§åˆ«

### æœ¬åœ°ç¼–è¯‘éƒ¨ç½²

### å®‰è£…etcd

**macOS:**
```bash
brew install etcd
etcd
```

**Linux:**
```bash
# ä¸‹è½½etcd
wget https://github.com/etcd-io/etcd/releases/download/v3.5.10/etcd-v3.5.10-linux-amd64.tar.gz
tar xzf etcd-v3.5.10-linux-amd64.tar.gz
cd etcd-v3.5.10-linux-amd64
./etcd
```

### ç¼–è¯‘é¡¹ç›®

```bash
cd distributed-task-scheduler
go mod download
go build -o bin/scheduler ./cmd/scheduler
go build -o bin/worker ./cmd/worker
go build -o bin/client ./cmd/client
```

### è¿è¡Œ

**1. å¯åŠ¨è°ƒåº¦å™¨ï¼š**
```bash
./bin/scheduler \
  --node-id=scheduler-1 \
  --etcd-endpoints=localhost:2379 \
  --queue=default \
  --strategy=round_robin \
  --log-level=info
```

**2. å¯åŠ¨å·¥ä½œèŠ‚ç‚¹ï¼š**
```bash
./bin/worker \
  --node-id=worker-1 \
  --etcd-endpoints=localhost:2379 \
  --queue=default \
  --max-concurrent=10 \
  --log-level=info
```

å¯ä»¥å¯åŠ¨å¤šä¸ªå·¥ä½œèŠ‚ç‚¹ã€‚

**3. æäº¤ä»»åŠ¡ï¼š**
```bash
./bin/client \
  --etcd-endpoints=localhost:2379 \
  --queue=default \
  --type=echo \
  --name=test-task \
  --priority=1 \
  --count=10
```

## ä½¿ç”¨è¯´æ˜

### è°ƒåº¦å™¨å‚æ•°

- `--node-id`: è°ƒåº¦å™¨èŠ‚ç‚¹IDï¼ˆé»˜è®¤ï¼šè‡ªåŠ¨ç”Ÿæˆï¼‰
- `--etcd-endpoints`: etcdç«¯ç‚¹ï¼Œé€—å·åˆ†éš”ï¼ˆé»˜è®¤ï¼šlocalhost:2379ï¼‰
- `--queue`: ä»»åŠ¡é˜Ÿåˆ—åç§°ï¼ˆé»˜è®¤ï¼šdefaultï¼‰
- `--strategy`: è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œå¯é€‰å€¼ï¼šround_robin, random, least_load, weightedï¼ˆé»˜è®¤ï¼šround_robinï¼‰
- `--log-level`: æ—¥å¿—çº§åˆ«ï¼Œå¯é€‰å€¼ï¼šdebug, info, warn, errorï¼ˆé»˜è®¤ï¼šinfoï¼‰

### å·¥ä½œèŠ‚ç‚¹å‚æ•°

- `--node-id`: å·¥ä½œèŠ‚ç‚¹IDï¼ˆé»˜è®¤ï¼šè‡ªåŠ¨ç”Ÿæˆï¼‰
- `--etcd-endpoints`: etcdç«¯ç‚¹ï¼Œé€—å·åˆ†éš”ï¼ˆé»˜è®¤ï¼šlocalhost:2379ï¼‰
- `--queue`: ä»»åŠ¡é˜Ÿåˆ—åç§°ï¼ˆé»˜è®¤ï¼šdefaultï¼‰
- `--max-concurrent`: æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°ï¼ˆé»˜è®¤ï¼š10ï¼‰
- `--log-level`: æ—¥å¿—çº§åˆ«ï¼ˆé»˜è®¤ï¼šinfoï¼‰

### å®¢æˆ·ç«¯å‚æ•°

- `--etcd-endpoints`: etcdç«¯ç‚¹ï¼ˆé»˜è®¤ï¼šlocalhost:2379ï¼‰
- `--queue`: ä»»åŠ¡é˜Ÿåˆ—åç§°ï¼ˆé»˜è®¤ï¼šdefaultï¼‰
- `--type`: ä»»åŠ¡ç±»å‹ï¼Œå¯é€‰å€¼ï¼šecho, compute, unreliableï¼ˆé»˜è®¤ï¼šechoï¼‰
- `--name`: ä»»åŠ¡åç§°ï¼ˆé»˜è®¤ï¼štest-taskï¼‰
- `--priority`: ä»»åŠ¡ä¼˜å…ˆçº§ï¼Œ0=ä½ï¼Œ1=æ™®é€šï¼Œ2=é«˜ï¼Œ3=ç´§æ€¥ï¼ˆé»˜è®¤ï¼š1ï¼‰
- `--count`: æäº¤ä»»åŠ¡æ•°é‡ï¼ˆé»˜è®¤ï¼š1ï¼‰

## ä»»åŠ¡ç±»å‹

ç³»ç»Ÿå†…ç½®äº†ä¸‰ç§ç¤ºä¾‹ä»»åŠ¡ç±»å‹ï¼š

1. **echo**: ç®€å•çš„å›æ˜¾ä»»åŠ¡ï¼Œæ‰§è¡Œæ—¶é—´çº¦1ç§’
2. **compute**: è®¡ç®—ä»»åŠ¡ï¼Œå¯é…ç½®æ‰§è¡Œæ—¶é—´
3. **unreliable**: ä¸å¯é ä»»åŠ¡ï¼Œç”¨äºæµ‹è¯•é‡è¯•æœºåˆ¶ï¼ˆå‰ä¸¤æ¬¡å¤±è´¥ï¼Œç¬¬ä¸‰æ¬¡æˆåŠŸï¼‰

## è‡ªå®šä¹‰ä»»åŠ¡æ‰§è¡Œå™¨

åœ¨ `cmd/worker/main.go` ä¸­å¯ä»¥æ³¨å†Œè‡ªå®šä¹‰ä»»åŠ¡æ‰§è¡Œå™¨ï¼š

```go
w.RegisterExecutor(task.NewBaseExecutor("my-task", func(ctx context.Context, t *task.Task) (*task.TaskResult, error) {
    // å®ç°ä»»åŠ¡é€»è¾‘
    return &task.TaskResult{
        TaskID: t.ID,
        Status: task.StatusCompleted,
        Result: "ä»»åŠ¡æ‰§è¡Œç»“æœ",
    }, nil
}))
```

## æµ‹è¯•

### è¿è¡Œå•å…ƒæµ‹è¯•

```bash
go test ./...
```

### è¿è¡ŒåŸºå‡†æµ‹è¯•

```bash
cd tests
go test -bench=. -benchmem
```

### è¿è¡Œè´Ÿè½½æµ‹è¯•

```bash
cd tests
go test -run TestConcurrentEnqueue -v
go test -run TestConcurrentDequeue -v
```

## æ€§èƒ½æµ‹è¯•

è¯¦ç»†çš„æ€§èƒ½æµ‹è¯•æŠ¥å‘Šè¯·å‚è€ƒ [docs/PERFORMANCE.md](docs/PERFORMANCE.md)

ä¸»è¦æ€§èƒ½æŒ‡æ ‡ï¼š
- å•å·¥ä½œèŠ‚ç‚¹ååé‡ï¼šçº¦ 10 ä»»åŠ¡/ç§’
- é˜Ÿåˆ—æ“ä½œå»¶è¿Ÿï¼š< 10ms
- ä»»åŠ¡åˆ†é…å»¶è¿Ÿï¼š< 1ç§’

## æ–‡æ¡£

- [æ¶æ„è®¾è®¡æ–‡æ¡£](docs/ARCHITECTURE.md) - è¯¦ç»†çš„ç³»ç»Ÿæ¶æ„è®¾è®¡
- [æ€§èƒ½æµ‹è¯•æŠ¥å‘Š](docs/PERFORMANCE.md) - æ€§èƒ½æµ‹è¯•å’Œåˆ†æ
- [æŠ€æœ¯æ€»ç»“æ–‡æ¡£](docs/TECHNICAL_SUMMARY.md) - æŠ€æœ¯å®ç°ç»†èŠ‚å’ŒæŒ‘æˆ˜è§£å†³æ–¹æ¡ˆ

## é¡¹ç›®ç»“æ„

```
distributed-task-scheduler/
â”œâ”€â”€ cmd/                  # å¯æ‰§è¡Œç¨‹åº
â”‚   â”œâ”€â”€ scheduler/        # è°ƒåº¦å™¨
â”‚   â”œâ”€â”€ worker/           # å·¥ä½œèŠ‚ç‚¹
â”‚   â””â”€â”€ client/           # å®¢æˆ·ç«¯
â”œâ”€â”€ internal/             # å†…éƒ¨å®ç°
â”‚   â”œâ”€â”€ scheduler/        # è°ƒåº¦å™¨é€»è¾‘
â”‚   â”œâ”€â”€ worker/           # å·¥ä½œèŠ‚ç‚¹é€»è¾‘
â”‚   â”œâ”€â”€ coordinator/      # etcdåè°ƒå™¨
â”‚   â”œâ”€â”€ queue/            # ä»»åŠ¡é˜Ÿåˆ—
â”‚   â””â”€â”€ common/           # é€šç”¨ç±»å‹
â”œâ”€â”€ pkg/                  # å¯å¯¼å‡ºåŒ…
â”‚   â”œâ”€â”€ task/             # ä»»åŠ¡å®šä¹‰å’Œæ‰§è¡Œå™¨
â”‚   â””â”€â”€ loadbalancer/     # è´Ÿè½½å‡è¡¡å™¨
â”œâ”€â”€ tests/                # æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ docs/                 # æ–‡æ¡£
â””â”€â”€ README.md
```

## æŠ€æœ¯æ ˆ

- **è¯­è¨€**: Go 1.21+
- **åè°ƒæœåŠ¡**: etcd v3.5
- **æ—¥å¿—**: zap
- **åºåˆ—åŒ–**: JSON

## è´Ÿè½½å‡è¡¡ç­–ç•¥

ç³»ç»Ÿæ”¯æŒå››ç§è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š

1. **round_robin**: è½®è¯¢åˆ†é…ï¼Œå…¬å¹³åˆ†é…ä»»åŠ¡
2. **random**: éšæœºåˆ†é…ï¼Œé€‚åˆè´Ÿè½½ç›¸è¿‘çš„åœºæ™¯
3. **least_load**: é€‰æ‹©è´Ÿè½½æœ€ä½çš„èŠ‚ç‚¹ï¼ŒåŸºäºCPUã€å†…å­˜å’Œè¿è¡Œä»»åŠ¡æ•°
4. **weighted**: æ ¹æ®èŠ‚ç‚¹æƒé‡åˆ†é…ï¼Œæ”¯æŒå¼‚æ„èŠ‚ç‚¹

## æ•…éšœæ¢å¤

- **èŠ‚ç‚¹æ•…éšœæ£€æµ‹**: é€šè¿‡etcd leaseæœºåˆ¶è‡ªåŠ¨æ£€æµ‹èŠ‚ç‚¹ä¸‹çº¿
- **ä»»åŠ¡é‡æ–°åˆ†é…**: æ•…éšœèŠ‚ç‚¹çš„ä»»åŠ¡è‡ªåŠ¨é‡æ–°å…¥é˜Ÿ
- **ä»»åŠ¡é‡è¯•**: å¤±è´¥ä»»åŠ¡æ”¯æŒè‡ªåŠ¨é‡è¯•ï¼Œå¯é…ç½®æœ€å¤§é‡è¯•æ¬¡æ•°

## ç›‘æ§

ç³»ç»Ÿæä¾›å®æ—¶ç»Ÿè®¡ä¿¡æ¯ï¼š

- **è°ƒåº¦å™¨ç»Ÿè®¡**: æ€»ä»»åŠ¡æ•°ã€é˜Ÿåˆ—é•¿åº¦ã€è¿è¡Œä¸­ä»»åŠ¡æ•°ã€å®Œæˆ/å¤±è´¥ä»»åŠ¡æ•°ã€å·¥ä½œèŠ‚ç‚¹æ•°
- **å·¥ä½œèŠ‚ç‚¹ç»Ÿè®¡**: æ€»ä»»åŠ¡æ•°ã€è¿è¡Œä¸­ä»»åŠ¡æ•°ã€CPU/å†…å­˜ä½¿ç”¨ç‡ã€å®Œæˆ/å¤±è´¥ä»»åŠ¡æ•°

## è®¸å¯è¯

MIT License

## è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼

## ä½œè€…

åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ

